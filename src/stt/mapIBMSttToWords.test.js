const _ = require('lodash');
const {of} = require('rxjs');
const {mergeMap} = require('rxjs/operators');
const {expect} = require('chai');
// const sinon = require('sinon');
const {marbles} = require('rxjs-marbles/mocha');

const mapIBMSttToWords = require('./mapIBMSttToWords');
const testExports = require('./mapIBMSttToWords').testExports;
const {
  createWordsStream,
  createSpeakerLabelsStream,
  filterSpeakerEvents,
  filterSpeakerForWord,
  filterWordEvents,
  createWordsWithSpeakers,
  mapResultToWords,
  mapEventToWords,
  parseJSON
} = testExports;

const events = [
  "{\n   \"state\": \"listening\"\n}",
  "{\n   \"result_index\": 0,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"so you \",\n               \"timestamps\": [\n                  [\n                     \"so\",\n                     0.0,\n                     0.24\n                  ],\n                  [\n                     \"you\",\n                     0.24,\n                     0.41\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ],\n   \"warnings\": [\n      \"Unknown URL query params: access_token. Websockets requests should have the parameters in WS messages, not in URL.\"\n   ]\n}",
  "{\n   \"result_index\": 0,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"soldiers say \",\n               \"timestamps\": [\n                  [\n                     \"soldiers\",\n                     0.0,\n                     0.77\n                  ],\n                  [\n                     \"say\",\n                     0.92,\n                     1.15\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 0,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"soldiers sailors and airmen of \",\n               \"timestamps\": [\n                  [\n                     \"soldiers\",\n                     0.0,\n                     0.77\n                  ],\n                  [\n                     \"sailors\",\n                     0.92,\n                     1.37\n                  ],\n                  [\n                     \"and\",\n                     1.37,\n                     1.59\n                  ],\n                  [\n                     \"airmen\",\n                     1.59,\n                     2.13\n                  ],\n                  [\n                     \"of\",\n                     2.2,\n                     2.41\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 0,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"soldiers sailors and airmen of the allied \",\n               \"timestamps\": [\n                  [\n                     \"soldiers\",\n                     0.0,\n                     0.77\n                  ],\n                  [\n                     \"sailors\",\n                     0.92,\n                     1.37\n                  ],\n                  [\n                     \"and\",\n                     1.37,\n                     1.59\n                  ],\n                  [\n                     \"airmen\",\n                     1.59,\n                     2.13\n                  ],\n                  [\n                     \"of\",\n                     2.2,\n                     2.38\n                  ],\n                  [\n                     \"the\",\n                     2.38,\n                     2.49\n                  ],\n                  [\n                     \"allied\",\n                     2.49,\n                     2.91\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 0,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"soldiers sailors and airmen of the allied expedition \",\n               \"timestamps\": [\n                  [\n                     \"soldiers\",\n                     0.0,\n                     0.77\n                  ],\n                  [\n                     \"sailors\",\n                     0.92,\n                     1.37\n                  ],\n                  [\n                     \"and\",\n                     1.37,\n                     1.59\n                  ],\n                  [\n                     \"airmen\",\n                     1.59,\n                     2.13\n                  ],\n                  [\n                     \"of\",\n                     2.2,\n                     2.38\n                  ],\n                  [\n                     \"the\",\n                     2.38,\n                     2.49\n                  ],\n                  [\n                     \"allied\",\n                     2.49,\n                     2.88\n                  ],\n                  [\n                     \"expedition\",\n                     2.88,\n                     3.41\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 0,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"soldiers sailors and airmen of the allied expeditionary force \",\n               \"timestamps\": [\n                  [\n                     \"soldiers\",\n                     0.0,\n                     0.77\n                  ],\n                  [\n                     \"sailors\",\n                     0.92,\n                     1.37\n                  ],\n                  [\n                     \"and\",\n                     1.37,\n                     1.59\n                  ],\n                  [\n                     \"airmen\",\n                     1.59,\n                     2.13\n                  ],\n                  [\n                     \"of\",\n                     2.2,\n                     2.38\n                  ],\n                  [\n                     \"the\",\n                     2.38,\n                     2.49\n                  ],\n                  [\n                     \"allied\",\n                     2.49,\n                     2.88\n                  ],\n                  [\n                     \"expeditionary\",\n                     2.88,\n                     3.64\n                  ],\n                  [\n                     \"force\",\n                     3.64,\n                     3.91\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 0,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"soldiers sailors and airmen of the allied expeditionary force \",\n               \"timestamps\": [\n                  [\n                     \"soldiers\",\n                     0.0,\n                     0.77\n                  ],\n                  [\n                     \"sailors\",\n                     0.92,\n                     1.37\n                  ],\n                  [\n                     \"and\",\n                     1.37,\n                     1.59\n                  ],\n                  [\n                     \"airmen\",\n                     1.59,\n                     2.13\n                  ],\n                  [\n                     \"of\",\n                     2.2,\n                     2.38\n                  ],\n                  [\n                     \"the\",\n                     2.38,\n                     2.49\n                  ],\n                  [\n                     \"allied\",\n                     2.49,\n                     2.88\n                  ],\n                  [\n                     \"expeditionary\",\n                     2.88,\n                     3.64\n                  ],\n                  [\n                     \"force\",\n                     3.64,\n                     4.12\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 0,\n   \"results\": [\n      {\n         \"final\": true,\n         \"alternatives\": [\n            {\n               \"transcript\": \"soldiers sailors and airmen of the allied expeditionary force \",\n               \"confidence\": 0.99,\n               \"timestamps\": [\n                  [\n                     \"soldiers\",\n                     0.0,\n                     0.77\n                  ],\n                  [\n                     \"sailors\",\n                     0.92,\n                     1.37\n                  ],\n                  [\n                     \"and\",\n                     1.37,\n                     1.59\n                  ],\n                  [\n                     \"airmen\",\n                     1.59,\n                     2.13\n                  ],\n                  [\n                     \"of\",\n                     2.2,\n                     2.38\n                  ],\n                  [\n                     \"the\",\n                     2.38,\n                     2.49\n                  ],\n                  [\n                     \"allied\",\n                     2.49,\n                     2.88\n                  ],\n                  [\n                     \"expeditionary\",\n                     2.88,\n                     3.64\n                  ],\n                  [\n                     \"force\",\n                     3.64,\n                     4.12\n                  ]\n               ],\n               \"word_confidence\": [\n                  [\n                     \"soldiers\",\n                     1.0\n                  ],\n                  [\n                     \"sailors\",\n                     1.0\n                  ],\n                  [\n                     \"and\",\n                     1.0\n                  ],\n                  [\n                     \"airmen\",\n                     1.0\n                  ],\n                  [\n                     \"of\",\n                     1.0\n                  ],\n                  [\n                     \"the\",\n                     1.0\n                  ],\n                  [\n                     \"allied\",\n                     0.97\n                  ],\n                  [\n                     \"expeditionary\",\n                     1.0\n                  ],\n                  [\n                     \"force\",\n                     0.97\n                  ]\n               ]\n            },\n            {\n               \"transcript\": \"soldiers sailors and airmen of the allied expeditionary force I \"\n            },\n            {\n               \"transcript\": \"soldiers sailors and airmen of the allied expeditionary force for \"\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"speaker_labels\": [\n      {\n         \"from\": 0.0,\n         \"to\": 0.77,\n         \"speaker\": 0,\n         \"confidence\": 0.53,\n         \"final\": false\n      },\n      {\n         \"from\": 0.92,\n         \"to\": 1.37,\n         \"speaker\": 1,\n         \"confidence\": 0.48,\n         \"final\": false\n      },\n      {\n         \"from\": 1.37,\n         \"to\": 1.59,\n         \"speaker\": 1,\n         \"confidence\": 0.48,\n         \"final\": false\n      },\n      {\n         \"from\": 1.59,\n         \"to\": 2.13,\n         \"speaker\": 1,\n         \"confidence\": 0.48,\n         \"final\": false\n      },\n      {\n         \"from\": 2.2,\n         \"to\": 2.38,\n         \"speaker\": 2,\n         \"confidence\": 0.49,\n         \"final\": false\n      },\n      {\n         \"from\": 2.38,\n         \"to\": 2.49,\n         \"speaker\": 2,\n         \"confidence\": 0.49,\n         \"final\": false\n      },\n      {\n         \"from\": 2.49,\n         \"to\": 2.88,\n         \"speaker\": 2,\n         \"confidence\": 0.49,\n         \"final\": false\n      },\n      {\n         \"from\": 2.88,\n         \"to\": 3.64,\n         \"speaker\": 2,\n         \"confidence\": 0.49,\n         \"final\": false\n      },\n      {\n         \"from\": 3.64,\n         \"to\": 4.12,\n         \"speaker\": 2,\n         \"confidence\": 0.49,\n         \"final\": false\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.15\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark on \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"on\",\n                     6.56,\n                     6.65\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the gray \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"gray\",\n                     6.98,\n                     7.15\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.65\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade for \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ],\n                  [\n                     \"for\",\n                     8.45,\n                     8.65\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ],\n                  [\n                     \"toward\",\n                     8.42,\n                     8.76\n                  ],\n                  [\n                     \"which\",\n                     8.76,\n                     8.98\n                  ],\n                  [\n                     \"we\",\n                     8.98,\n                     9.15\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we have striven \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ],\n                  [\n                     \"toward\",\n                     8.42,\n                     8.76\n                  ],\n                  [\n                     \"which\",\n                     8.76,\n                     8.98\n                  ],\n                  [\n                     \"we\",\n                     8.98,\n                     9.09\n                  ],\n                  [\n                     \"have\",\n                     9.09,\n                     9.23\n                  ],\n                  [\n                     \"striven\",\n                     9.23,\n                     9.65\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we have striven these many \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ],\n                  [\n                     \"toward\",\n                     8.42,\n                     8.76\n                  ],\n                  [\n                     \"which\",\n                     8.76,\n                     8.98\n                  ],\n                  [\n                     \"we\",\n                     8.98,\n                     9.09\n                  ],\n                  [\n                     \"have\",\n                     9.09,\n                     9.23\n                  ],\n                  [\n                     \"striven\",\n                     9.23,\n                     9.63\n                  ],\n                  [\n                     \"these\",\n                     9.63,\n                     9.87\n                  ],\n                  [\n                     \"many\",\n                     9.87,\n                     10.15\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we have striven these many months \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ],\n                  [\n                     \"toward\",\n                     8.42,\n                     8.76\n                  ],\n                  [\n                     \"which\",\n                     8.76,\n                     8.98\n                  ],\n                  [\n                     \"we\",\n                     8.98,\n                     9.09\n                  ],\n                  [\n                     \"have\",\n                     9.09,\n                     9.23\n                  ],\n                  [\n                     \"striven\",\n                     9.23,\n                     9.63\n                  ],\n                  [\n                     \"these\",\n                     9.63,\n                     9.87\n                  ],\n                  [\n                     \"many\",\n                     9.87,\n                     10.11\n                  ],\n                  [\n                     \"months\",\n                     10.11,\n                     10.65\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we have striven these many months \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ],\n                  [\n                     \"toward\",\n                     8.42,\n                     8.76\n                  ],\n                  [\n                     \"which\",\n                     8.76,\n                     8.98\n                  ],\n                  [\n                     \"we\",\n                     8.98,\n                     9.09\n                  ],\n                  [\n                     \"have\",\n                     9.09,\n                     9.23\n                  ],\n                  [\n                     \"striven\",\n                     9.23,\n                     9.63\n                  ],\n                  [\n                     \"these\",\n                     9.63,\n                     9.87\n                  ],\n                  [\n                     \"many\",\n                     9.87,\n                     10.11\n                  ],\n                  [\n                     \"months\",\n                     10.11,\n                     10.68\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we have striven these many months the I. is lower \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ],\n                  [\n                     \"toward\",\n                     8.42,\n                     8.76\n                  ],\n                  [\n                     \"which\",\n                     8.76,\n                     8.98\n                  ],\n                  [\n                     \"we\",\n                     8.98,\n                     9.09\n                  ],\n                  [\n                     \"have\",\n                     9.09,\n                     9.23\n                  ],\n                  [\n                     \"striven\",\n                     9.23,\n                     9.63\n                  ],\n                  [\n                     \"these\",\n                     9.63,\n                     9.87\n                  ],\n                  [\n                     \"many\",\n                     9.87,\n                     10.11\n                  ],\n                  [\n                     \"months\",\n                     10.11,\n                     10.68\n                  ],\n                  [\n                     \"the\",\n                     11.28,\n                     11.52\n                  ],\n                  [\n                     \"I.\",\n                     11.52,\n                     11.67\n                  ],\n                  [\n                     \"is\",\n                     11.67,\n                     11.86\n                  ],\n                  [\n                     \"lower\",\n                     11.86,\n                     12.15\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we have striven these many months the eyes of the world are \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ],\n                  [\n                     \"toward\",\n                     8.42,\n                     8.76\n                  ],\n                  [\n                     \"which\",\n                     8.76,\n                     8.98\n                  ],\n                  [\n                     \"we\",\n                     8.98,\n                     9.09\n                  ],\n                  [\n                     \"have\",\n                     9.09,\n                     9.23\n                  ],\n                  [\n                     \"striven\",\n                     9.23,\n                     9.63\n                  ],\n                  [\n                     \"these\",\n                     9.63,\n                     9.87\n                  ],\n                  [\n                     \"many\",\n                     9.87,\n                     10.11\n                  ],\n                  [\n                     \"months\",\n                     10.11,\n                     10.68\n                  ],\n                  [\n                     \"the\",\n                     11.28,\n                     11.52\n                  ],\n                  [\n                     \"eyes\",\n                     11.52,\n                     11.84\n                  ],\n                  [\n                     \"of\",\n                     11.84,\n                     11.93\n                  ],\n                  [\n                     \"the\",\n                     11.93,\n                     12.0\n                  ],\n                  [\n                     \"world\",\n                     12.0,\n                     12.36\n                  ],\n                  [\n                     \"are\",\n                     12.36,\n                     12.55\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": false,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we have striven these many months the eyes of the world are upon you \",\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ],\n                  [\n                     \"toward\",\n                     8.42,\n                     8.76\n                  ],\n                  [\n                     \"which\",\n                     8.76,\n                     8.98\n                  ],\n                  [\n                     \"we\",\n                     8.98,\n                     9.09\n                  ],\n                  [\n                     \"have\",\n                     9.09,\n                     9.23\n                  ],\n                  [\n                     \"striven\",\n                     9.23,\n                     9.63\n                  ],\n                  [\n                     \"these\",\n                     9.63,\n                     9.87\n                  ],\n                  [\n                     \"many\",\n                     9.87,\n                     10.11\n                  ],\n                  [\n                     \"months\",\n                     10.11,\n                     10.68\n                  ],\n                  [\n                     \"the\",\n                     11.28,\n                     11.52\n                  ],\n                  [\n                     \"eyes\",\n                     11.52,\n                     11.84\n                  ],\n                  [\n                     \"of\",\n                     11.84,\n                     11.93\n                  ],\n                  [\n                     \"the\",\n                     11.93,\n                     12.0\n                  ],\n                  [\n                     \"world\",\n                     12.0,\n                     12.36\n                  ],\n                  [\n                     \"are\",\n                     12.36,\n                     12.48\n                  ],\n                  [\n                     \"upon\",\n                     12.48,\n                     12.77\n                  ],\n                  [\n                     \"you\",\n                     12.77,\n                     13.02\n                  ]\n               ],\n               \"word_confidence\": []\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"result_index\": 1,\n   \"results\": [\n      {\n         \"final\": true,\n         \"alternatives\": [\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we have striven these many months the eyes of the world are upon you \",\n               \"confidence\": 0.96,\n               \"timestamps\": [\n                  [\n                     \"you\",\n                     5.18,\n                     5.39\n                  ],\n                  [\n                     \"are\",\n                     5.39,\n                     5.58\n                  ],\n                  [\n                     \"about\",\n                     5.58,\n                     5.92\n                  ],\n                  [\n                     \"to\",\n                     5.95,\n                     6.09\n                  ],\n                  [\n                     \"embark\",\n                     6.09,\n                     6.56\n                  ],\n                  [\n                     \"upon\",\n                     6.56,\n                     6.89\n                  ],\n                  [\n                     \"the\",\n                     6.89,\n                     6.98\n                  ],\n                  [\n                     \"great\",\n                     6.98,\n                     7.25\n                  ],\n                  [\n                     \"crusade\",\n                     7.25,\n                     7.87\n                  ],\n                  [\n                     \"toward\",\n                     8.42,\n                     8.76\n                  ],\n                  [\n                     \"which\",\n                     8.76,\n                     8.98\n                  ],\n                  [\n                     \"we\",\n                     8.98,\n                     9.09\n                  ],\n                  [\n                     \"have\",\n                     9.09,\n                     9.23\n                  ],\n                  [\n                     \"striven\",\n                     9.23,\n                     9.63\n                  ],\n                  [\n                     \"these\",\n                     9.63,\n                     9.87\n                  ],\n                  [\n                     \"many\",\n                     9.87,\n                     10.11\n                  ],\n                  [\n                     \"months\",\n                     10.11,\n                     10.68\n                  ],\n                  [\n                     \"the\",\n                     11.28,\n                     11.52\n                  ],\n                  [\n                     \"eyes\",\n                     11.52,\n                     11.84\n                  ],\n                  [\n                     \"of\",\n                     11.84,\n                     11.93\n                  ],\n                  [\n                     \"the\",\n                     11.93,\n                     12.0\n                  ],\n                  [\n                     \"world\",\n                     12.0,\n                     12.36\n                  ],\n                  [\n                     \"are\",\n                     12.36,\n                     12.48\n                  ],\n                  [\n                     \"upon\",\n                     12.48,\n                     12.77\n                  ],\n                  [\n                     \"you\",\n                     12.77,\n                     13.02\n                  ]\n               ],\n               \"word_confidence\": [\n                  [\n                     \"you\",\n                     0.82\n                  ],\n                  [\n                     \"are\",\n                     1.0\n                  ],\n                  [\n                     \"about\",\n                     1.0\n                  ],\n                  [\n                     \"to\",\n                     1.0\n                  ],\n                  [\n                     \"embark\",\n                     1.0\n                  ],\n                  [\n                     \"upon\",\n                     1.0\n                  ],\n                  [\n                     \"the\",\n                     1.0\n                  ],\n                  [\n                     \"great\",\n                     1.0\n                  ],\n                  [\n                     \"crusade\",\n                     0.99\n                  ],\n                  [\n                     \"toward\",\n                     1.0\n                  ],\n                  [\n                     \"which\",\n                     1.0\n                  ],\n                  [\n                     \"we\",\n                     1.0\n                  ],\n                  [\n                     \"have\",\n                     1.0\n                  ],\n                  [\n                     \"striven\",\n                     1.0\n                  ],\n                  [\n                     \"these\",\n                     1.0\n                  ],\n                  [\n                     \"many\",\n                     1.0\n                  ],\n                  [\n                     \"months\",\n                     0.99\n                  ],\n                  [\n                     \"the\",\n                     1.0\n                  ],\n                  [\n                     \"eyes\",\n                     0.96\n                  ],\n                  [\n                     \"of\",\n                     0.93\n                  ],\n                  [\n                     \"the\",\n                     1.0\n                  ],\n                  [\n                     \"world\",\n                     1.0\n                  ],\n                  [\n                     \"are\",\n                     1.0\n                  ],\n                  [\n                     \"upon\",\n                     0.43\n                  ],\n                  [\n                     \"you\",\n                     0.95\n                  ]\n               ]\n            },\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we have striven these many months the eyes of the world are fine you \"\n            },\n            {\n               \"transcript\": \"you are about to embark upon the great crusade toward which we have striven these many months the eyes of the world are fun you \"\n            }\n         ]\n      }\n   ]\n}",
  "{\n   \"speaker_labels\": [\n      {\n         \"from\": 2.2,\n         \"to\": 2.38,\n         \"speaker\": 1,\n         \"confidence\": 0.36,\n         \"final\": false\n      },\n      {\n         \"from\": 2.38,\n         \"to\": 2.49,\n         \"speaker\": 1,\n         \"confidence\": 0.36,\n         \"final\": false\n      },\n      {\n         \"from\": 2.49,\n         \"to\": 2.88,\n         \"speaker\": 1,\n         \"confidence\": 0.36,\n         \"final\": false\n      },\n      {\n         \"from\": 2.88,\n         \"to\": 3.64,\n         \"speaker\": 1,\n         \"confidence\": 0.36,\n         \"final\": false\n      },\n      {\n         \"from\": 3.64,\n         \"to\": 4.12,\n         \"speaker\": 1,\n         \"confidence\": 0.36,\n         \"final\": false\n      },\n      {\n         \"from\": 5.18,\n         \"to\": 5.39,\n         \"speaker\": 2,\n         \"confidence\": 0.46,\n         \"final\": false\n      },\n      {\n         \"from\": 5.39,\n         \"to\": 5.58,\n         \"speaker\": 2,\n         \"confidence\": 0.46,\n         \"final\": false\n      },\n      {\n         \"from\": 5.58,\n         \"to\": 5.92,\n         \"speaker\": 2,\n         \"confidence\": 0.46,\n         \"final\": false\n      },\n      {\n         \"from\": 5.95,\n         \"to\": 6.09,\n         \"speaker\": 1,\n         \"confidence\": 0.39,\n         \"final\": false\n      },\n      {\n         \"from\": 6.09,\n         \"to\": 6.56,\n         \"speaker\": 1,\n         \"confidence\": 0.39,\n         \"final\": false\n      },\n      {\n         \"from\": 6.56,\n         \"to\": 6.89,\n         \"speaker\": 1,\n         \"confidence\": 0.39,\n         \"final\": false\n      },\n      {\n         \"from\": 6.89,\n         \"to\": 6.98,\n         \"speaker\": 1,\n         \"confidence\": 0.39,\n         \"final\": false\n      },\n      {\n         \"from\": 6.98,\n         \"to\": 7.25,\n         \"speaker\": 1,\n         \"confidence\": 0.39,\n         \"final\": false\n      },\n      {\n         \"from\": 7.25,\n         \"to\": 7.87,\n         \"speaker\": 1,\n         \"confidence\": 0.39,\n         \"final\": false\n      },\n      {\n         \"from\": 8.42,\n         \"to\": 8.76,\n         \"speaker\": 1,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 8.76,\n         \"to\": 8.98,\n         \"speaker\": 1,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 8.98,\n         \"to\": 9.09,\n         \"speaker\": 1,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 9.09,\n         \"to\": 9.23,\n         \"speaker\": 1,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 9.23,\n         \"to\": 9.63,\n         \"speaker\": 1,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 9.63,\n         \"to\": 9.87,\n         \"speaker\": 1,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 9.87,\n         \"to\": 10.11,\n         \"speaker\": 1,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 10.11,\n         \"to\": 10.68,\n         \"speaker\": 1,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 11.28,\n         \"to\": 11.52,\n         \"speaker\": 2,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 11.52,\n         \"to\": 11.84,\n         \"speaker\": 2,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 11.84,\n         \"to\": 11.93,\n         \"speaker\": 2,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 11.93,\n         \"to\": 12.0,\n         \"speaker\": 2,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 12.0,\n         \"to\": 12.36,\n         \"speaker\": 2,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 12.36,\n         \"to\": 12.48,\n         \"speaker\": 2,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 12.48,\n         \"to\": 12.77,\n         \"speaker\": 2,\n         \"confidence\": 0.4,\n         \"final\": false\n      },\n      {\n         \"from\": 12.77,\n         \"to\": 13.02,\n         \"speaker\": 2,\n         \"confidence\": 0.4,\n         \"final\": false\n      }\n   ]\n}",
];

const rawWords = [
  {
    "word": "soldiers",
    "confidence": 1,
    "start": 0,
    "end": 0.77,
  },
  {
    "word": "sailors",
    "confidence": 1,
    "start": 0.92,
    "end": 1.37,
  },
  {
    "word": "and",
    "confidence": 1,
    "start": 1.37,
    "end": 1.59,
  },
  {
    "word": "airmen",
    "confidence": 1,
    "start": 1.59,
    "end": 2.13,
  },
  {
    "word": "of",
    "confidence": 1,
    "start": 2.2,
    "end": 2.38,
  },
  {
    "word": "the",
    "confidence": 1,
    "start": 2.38,
    "end": 2.49,
  },
  {
    "word": "allied",
    "confidence": 0.97,
    "start": 2.49,
    "end": 2.88,
  },
  {
    "word": "expeditionary",
    "confidence": 1,
    "start": 2.88,
    "end": 3.64,
  },
  {
    "word": "force",
    "confidence": 0.97,
    "start": 3.64,
    "end": 4.12,
  },
];

const rawSpeakerLabels = [
  {"from":0,"to":0.77,"speaker":0,"confidence":0.53,"final":false},
  {"from":0.92,"to":1.37,"speaker":1,"confidence":0.48,"final":false},
  {"from":1.37,"to":1.59,"speaker":1,"confidence":0.48,"final":false},
  {"from":1.59,"to":2.13,"speaker":1,"confidence":0.48,"final":false},
  {"from":2.2,"to":2.38,"speaker":2,"confidence":0.49,"final":false},
  {"from":2.38,"to":2.49,"speaker":2,"confidence":0.49,"final":false},
  {"from":2.49,"to":2.88,"speaker":2,"confidence":0.49,"final":false},
  {"from":2.88,"to":3.64,"speaker":2,"confidence":0.49,"final":false},
  {"from":3.64,"to":4.12,"speaker":2,"confidence":0.49,"final":false}
];

const normalizedWords = [
  {
    word: 'soldiers',
    confidence: 1.0,
    start: 0,
    end: 0.77,
    speaker: 0,
    speakerConfidence: 0.53,
  },
  {
    word: 'sailors',
    confidence: 1.0,
    start: 0.92,
    end: 1.37,
    speaker: 1,
    speakerConfidence: 0.48,
  },
  {
    word: 'and',
    confidence: 1.0,
    start: 1.37,
    end: 1.59,
    speaker: 1,
    speakerConfidence: 0.48,
  },
  {
    word: 'airmen',
    confidence: 1.0,
    start: 1.59,
    end: 2.13,
    speaker: 1,
    speakerConfidence: 0.48,
  },
  {
    word: 'of',
    confidence: 1.0,
    start: 2.2,
    end: 2.38,
    speaker: 2,
    speakerConfidence: 0.49,
  },
  {
    word: 'the',
    confidence: 1.0,
    start: 2.38,
    end: 2.49,
    speaker: 2,
    speakerConfidence: 0.49,
  },
  {
    word: 'allied',
    confidence: 0.97,
    start: 2.49,
    end: 2.88,
    speaker: 2,
    speakerConfidence: 0.49,
  },
  {
    word: 'expeditionary',
    confidence: 1.0,
    start: 2.88,
    end: 3.64,
    speaker: 2,
    speakerConfidence: 0.49,
  },
  {
    word: 'force',
    confidence: 0.97,
    start: 3.64,
    end: 4.12,
    speaker: 2,
    speakerConfidence: 0.49,
  },
];

describe('operators.mapIBMSttToWords', () => {
  it('should export a curried function', () => {
    expect(mapIBMSttToWords).to.be.a('function');
    expect(mapIBMSttToWords()).to.be.a('function');
  });

  it('should convert events into normalized words', marbles(m => {
    const testEvents = _.take(events, 10);
    const input$ = m.cold('012345678(9|)', testEvents);
    const actual$ = input$.pipe(mapIBMSttToWords());
    const expected$ = m.cold('---------(012345678|)', normalizedWords);
    m.expect(actual$).toBeObservable(expected$);
  }));

  it('should map result to words', () => {
    const eventStr = events[8];
    const {results} = JSON.parse(eventStr);
    const words = mapResultToWords()(results[0]);
    expect(words).to.deep.equal(rawWords);
  });

  it('should filter out irrelevant word events', () => {
    const resultEvents = events.map(str => JSON.parse(str));
    const matches = resultEvents.filter(filterWordEvents());
    expect(matches.length).to.equal(23);
  });

  it('should parse events from strings correctly', marbles(m => {
    const eventStr = events[8];
    const actual$ = parseJSON(eventStr);
    const expected$ = m.cold('(0|)', [JSON.parse(eventStr)]);
    m.expect(actual$).toBeObservable(expected$);
  }));

  it('should filter in speaker events properly', () => {
    const results = events.map(str => JSON.parse(str));
    const matches = results.filter(filterSpeakerEvents());
    expect(matches.length).to.equal(2);
    expect(matches[0]).to.equal(results[9]);
  });

  it('should read raw words stream from event stream', marbles(m => {
    const input$ = m.cold('0123456789', events);
    // const input$ = of(...events);
    const actual$ = input$.pipe(
      mergeMap(parseJSON),
      createWordsStream()
    );
    const expected$ = m.cold('--------0', [rawWords]);
    m.expect(actual$).toBeObservable(expected$);
  }));

  it('should read raw speaker label stream from event stream', marbles(m => {
    const input$ = m.cold('0123456789', events);
    // const input$ = of(...events);
    const actual$ = input$.pipe(
      mergeMap(parseJSON),
      createSpeakerLabelsStream()
    );
    const expected$ = m.cold('---------0', [rawSpeakerLabels]);
    m.expect(actual$).toBeObservable(expected$);
  }));
});
